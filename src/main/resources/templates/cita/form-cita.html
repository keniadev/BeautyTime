<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/_mainLayout}">
<head>

    <link rel="stylesheet" href="/css/form-cita.css">
</head>
<body>
<div layout:fragment="content">
    <div class="appointment-container">

        <h2 class="appointment-title">Agendar Cita</h2>

        <div class="user-info">
            Nombre: <span class="user-name" th:text="${usuario.nombre}"></span> <span class="user-name" th:text="${usuario.apellido}"></span>
        </div>
        <form class="appointment-form" th:action="@{/citas/confirmar}" method="post" id="appointmentForm" novalidate>
            <input type="hidden" name="usuarioId" th:value="${usuario.id}"/>

            <div class="form-group">
                <label for="telefono">Teléfono:</label>
                <input type="text" id="telefono" name="telefono"
                       placeholder="Tu teléfono"
                       pattern="[0-9]{8,15}"
                       title="El teléfono debe tener entre 8 y 15 dígitos y solo números"
                       required/>
            </div>


            <div class="form-group">
                <label for="servicio">Servicio:</label>
                <select id="servicio" name="servicioId" required>
                    <option value="">Selecciona un servicio</option>
                    <option th:each="serv : ${servicios}"
                            th:value="${serv.id}"
                            th:text="${serv.nombreServicio}"></option>
                </select>
            </div>

            <div class="form-group">
                <label for="fecha">Fecha de la cita:</label>
                <input type="date" id="fecha" name="fecha" required/>
            </div>

            <div class="form-group">
                <label for="cupos">Cupos disponibles:</label>
                <select name="cupoId" id="cupos" required>
                    <option value="">Selecciona un servicio y una fecha</option>
                </select>
            </div>

            <div class="button-group">
                <button type="submit" class="appointment-button submit-button">Agendar Cita</button>
                <button type="button" class="appointment-button cancel-button" onclick="window.history.back();">Cancelar</button>
            </div>
        </form>


        <div th:if="${error}" class="hidden-error" th:text="${error}"></div>

    </div>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {


$('#telefono').on('input', function() {
    this.value = this.value.replace(/[^0-9]/g, '');
    if (this.value.length > 15) {
        this.value = this.value.substring(0, 15);
    }
});


            $('#appointmentForm').on('submit', function(e) {

                e.preventDefault();

                const form = this;
                let isValid = true;


                $(form).find('[required]').each(function() {
                    if (!$(this).val()) {
                        isValid = false;
                        return false; // Salir del bucle .each()
                    }
                });

                if (!isValid) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Campos Vacíos',
                        text: 'Por favor, completa todos los campos requeridos para agendar la cita.',
                        confirmButtonColor: '#6a0572'
                    });
                } else {

                    Swal.fire({
                        title: '¿Confirmar Cita?',
                        text: 'Una vez agendada, no podrás revertir esta acción fácilmente.',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#6a0572',
                        cancelButtonColor: '#d1b1c6',
                        confirmButtonText: 'Sí, agendar',
                        cancelButtonText: 'No, cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Muestra un mensaje de éxito antes de enviar el formulario
                            Swal.fire({
                                title: '¡Éxito!',
                                text: 'Tu cita ha sido agendada correctamente.',
                                icon: 'success',
                                confirmButtonColor: '#6a0572',
                                timer: 2000,
                                timerProgressBar: true,
                                didClose: () => {
                                    form.submit();
                                }
                            });
                        }
                    });
                }
            });


            function cargarCupos() {
                var fecha = $('#fecha').val();
                var servicioId = $('#servicio').val();

                if(fecha && servicioId) {
                    $.ajax({
                        url: '/cupos-disponibles',
                        data: { fecha: fecha, servicioId: servicioId },
                        success: function(cupos) {
                            var cuposSelect = $('#cupos');
                            var seleccionAnterior = cuposSelect.val();

                            cuposSelect.empty();
                            if(cupos.length > 0) {
                                cupos.forEach(function(cupo) {
                                    cuposSelect.append(
                                        $('<option></option>')
                                            .val(cupo.id)
                                            .text(cupo.nombreTurno + ' | ' + cupo.horaInicio + ' - ' + cupo.horaFin)
                                    );
                                });

                                if(seleccionAnterior && cuposSelect.find('option[value="' + seleccionAnterior + '"]').length > 0){
                                    cuposSelect.val(seleccionAnterior);
                                } else {
                                    cuposSelect.val('');
                                }

                            } else {
                                cuposSelect.append('<option value="">No hay cupos disponibles</option>');
                            }
                        },
                        error: function() {
                            $('#cupos').empty();
                            $('#cupos').append('<option value="">Error al cargar cupos</option>');
                        }
                    });
                } else {
                    $('#cupos').html('<option value="">Selecciona un servicio y una fecha</option>');
                }
            }
            $('#fecha').change(cargarCupos);
            $('#servicio').change(cargarCupos);
            setInterval(cargarCupos, 1000);
        });
    </script>
</div>
</body>
</html>
